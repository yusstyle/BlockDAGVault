import v from"express";import{createServer as E}from"http";var l=class{documents;constructor(){this.documents=new Map}async storeEncryptedDocument(r,s,t){this.documents.set(r,{documentId:r,encryptedData:s,iv:t,granteeKeys:{}})}async getEncryptedDocument(r){return this.documents.get(r)}async deleteDocument(r){this.documents.delete(r)}async addGranteeKey(r,s,t){let e=this.documents.get(r);e&&(e.granteeKeys||(e.granteeKeys={}),e.granteeKeys[s.toLowerCase()]=t)}async getGranteeKey(r,s){return this.documents.get(r)?.granteeKeys?.[s.toLowerCase()]}},m=new l;async function h(o){return o.post("/api/documents/store",async(s,t)=>{try{let{documentId:e,encryptedData:n,iv:i}=s.body;if(!e||!n||!i)return t.status(400).json({error:"Missing required fields"});await m.storeEncryptedDocument(e,n,i),t.json({success:!0})}catch(e){console.error("Store document error:",e),t.status(500).json({error:e.message||"Failed to store document"})}}),o.get("/api/documents/:documentId",async(s,t)=>{try{let{documentId:e}=s.params,n=await m.getEncryptedDocument(e);if(!n)return t.status(404).json({error:"Document not found"});t.json(n)}catch(e){console.error("Get document error:",e),t.status(500).json({error:e.message||"Failed to retrieve document"})}}),o.delete("/api/documents/:documentId",async(s,t)=>{try{let{documentId:e}=s.params;await m.deleteDocument(e),t.json({success:!0})}catch(e){console.error("Delete document error:",e),t.status(500).json({error:e.message||"Failed to delete document"})}}),o.post("/api/documents/:documentId/grantee-key",async(s,t)=>{try{let{documentId:e}=s.params,{granteeAddress:n,encryptedKey:i}=s.body;if(!n||!i)return t.status(400).json({error:"Missing grantee address or encrypted key"});await m.addGranteeKey(e,n,i),t.json({success:!0})}catch(e){console.error("Add grantee key error:",e),t.status(500).json({error:e.message||"Failed to store grantee key"})}}),o.get("/api/documents/:documentId/grantee-key/:granteeAddress",async(s,t)=>{try{let{documentId:e,granteeAddress:n}=s.params,i=await m.getGranteeKey(e,n);if(!i)return t.status(404).json({error:"Grantee key not found"});t.json({encryptedKey:i})}catch(e){console.error("Get grantee key error:",e),t.status(500).json({error:e.message||"Failed to retrieve grantee key"})}}),E(o)}import _ from"express";import D from"fs";import y from"path";import{createServer as $,createLogger as G}from"vite";import{defineConfig as P}from"vite";import K from"@vitejs/plugin-react";import u from"path";import R from"@replit/vite-plugin-runtime-error-modal";import{fileURLToPath as k}from"url";var F=k(import.meta.url),p=u.dirname(F),x=P({plugins:[K(),R(),...process.env.NODE_ENV!=="production"&&process.env.REPL_ID!==void 0?[await import("@replit/vite-plugin-cartographer").then(o=>o.cartographer()),await import("@replit/vite-plugin-dev-banner").then(o=>o.devBanner())]:[]],resolve:{alias:{"@":u.resolve(p,"client","src"),"@shared":u.resolve(p,"shared"),"@assets":u.resolve(p,"attached_assets")}},root:u.resolve(p,"client"),build:{outDir:u.resolve(p,"dist/public"),emptyOutDir:!0},server:{fs:{strict:!0,deny:["**/.*"]}}});import{nanoid as L}from"nanoid";var w=G();function f(o,r="express"){let s=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${s} [${r}] ${o}`)}async function S(o,r){let s={middlewareMode:!0,hmr:{server:r},allowedHosts:!0},t=await $({...x,configFile:!1,customLogger:{...w,error:(e,n)=>{w.error(e,n),process.exit(1)}},server:s,appType:"custom"});o.use(t.middlewares),o.use("*",async(e,n,i)=>{let c=e.originalUrl;try{let a=y.resolve(import.meta.dirname,"..","client","index.html"),g=await D.promises.readFile(a,"utf-8");g=g.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${L()}"`);let j=await t.transformIndexHtml(c,g);n.status(200).set({"Content-Type":"text/html"}).end(j)}catch(a){t.ssrFixStacktrace(a),i(a)}})}function I(o){let r=y.resolve(import.meta.dirname,"public");if(!D.existsSync(r))throw new Error(`Could not find the build directory: ${r}, make sure to build the client first`);o.use(_.static(r)),o.use("*",(s,t)=>{t.sendFile(y.resolve(r,"index.html"))})}var d=v();d.use(v.json({verify:(o,r,s)=>{o.rawBody=s}}));d.use(v.urlencoded({extended:!1}));d.use((o,r,s)=>{let t=Date.now(),e=o.path,n,i=r.json;r.json=function(c,...a){return n=c,i.apply(r,[c,...a])},r.on("finish",()=>{let c=Date.now()-t;if(e.startsWith("/api")){let a=`${o.method} ${e} ${r.statusCode} in ${c}ms`;n&&(a+=` :: ${JSON.stringify(n)}`),a.length>80&&(a=a.slice(0,79)+"\u2026"),f(a)}}),s()});(async()=>{let o=await h(d);d.use((s,t,e,n)=>{let i=s.status||s.statusCode||500,c=s.message||"Internal Server Error";throw e.status(i).json({message:c}),s}),d.get("env")==="development"?await S(d,o):I(d);let r=parseInt(process.env.PORT||"5001",10);o.listen(r,()=>{f(`serving on port ${r}`)})})();
